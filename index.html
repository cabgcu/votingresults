<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lip Sync 2025 Results</title>

<script src="https://cdn.tailwindcss.com"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getFirestore, collection, query, onSnapshot, doc, setDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyBoYf1_IhILJ96Y9KMcwrVjHMFLT5YEKuQ",
  authDomain: "lip-sync-2025.firebaseapp.com",
  projectId: "lip-sync-2025",
  storageBucket: "lip-sync-2025.firebasestorage.app",
  messagingSenderId: "118581305479",
  appId: "1:118581305479:web:7a7335c1be6e816cc7d822",
  measurementId: "G-NQ0GMG05Q2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let votingEnabled = true;

/* SHA-256 helper */
async function sha256Hex(text) {
  const enc = new TextEncoder().encode(text);
  const hashBuffer = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, "0")).join("");
}

/* Firestore listeners */
function subscribeToVotes() {
  const q = query(collection(db, "lip_sync_2025_votes"));
  onSnapshot(q, (snap) => {
    const counts = { option1:0, option2:0, option3:0, option4:0, option5:0, option6:0 };
    snap.forEach(d => { if (d.data().voteId in counts) counts[d.data().voteId]++; });
    renderResults(counts);
  });
  onSnapshot(doc(db, "lip_sync_2025_settings", "state"), (snap) => {
    if (snap.exists()) {
      votingEnabled = snap.data().enabled;
      updateStatus();
    }
  });
}

function renderResults(counts) {
  const names = ["Below","Deliverance","Mask Off","Metro Motion","Sin Games","Anonymity"];
  const total = Object.values(counts).reduce((a,b)=>a+b,0);
  const list = document.getElementById("results-list");
  list.innerHTML = Object.keys(counts).map((id,i)=>{
    const pct = total ? ((counts[id]/total)*100).toFixed(1) : 0;
    return `
      <div class="space-y-1 text-white">
        <div class="flex justify-between text-xs sm:text-sm">
          <span>${names[i]}</span>
          <span>${counts[id]} votes (${pct}%)</span>
        </div>
        <div class="w-full h-3 bg-white/10 rounded-full overflow-hidden">
          <div class="h-full bg-green-500 transition-all duration-700 ease-in-out" style="width:${pct}%"></div>
        </div>
      </div>`;
  }).join('');
  document.getElementById("total-votes").textContent = `Total Votes: ${total}`;
}

async function toggleVoting() {
  votingEnabled = !votingEnabled;
  await setDoc(doc(db, "lip_sync_2025_settings", "state"), { enabled: votingEnabled });
  updateStatus();
}

async function clearResults() {
  if (!confirm("Clear all votes?")) return;
  const qSnap = await getDocs(collection(db, "lip_sync_2025_votes"));
  const deletions = qSnap.docs.map(d => deleteDoc(d.ref));
  await Promise.all(deletions);
  alert("All results cleared!");
}

function updateStatus() {
  const label = document.getElementById("voting-status-label");
  label.textContent = votingEnabled ? "Voting: ON" : "Voting: OFF";
  label.className = votingEnabled ? "text-green-400 font-semibold mb-3" : "text-red-400 font-semibold mb-3";
  document.getElementById("toggle-voting-btn").textContent = votingEnabled ? "Turn Off Voting" : "Turn On Voting";
}

/* Password Gate (SHA-256 hash of "Canyon49!") */
const correctHash = "0a4fe117d8805dd33750e1e52cfa0be0d0d3e90cf03beb37b2a3443d76d99f27";

document.addEventListener("DOMContentLoaded", () => {
  const loginForm = document.getElementById("login-form");
  const loginSection = document.getElementById("login-section");
  const resultsSection = document.getElementById("results-section");

  loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const entered = document.getElementById("password").value.trim();
    const hash = await sha256Hex(entered);
    if (hash === correctHash) {
      loginSection.classList.add("hidden");
      resultsSection.classList.remove("hidden");
      document.getElementById("toggle-voting-btn").addEventListener("click", toggleVoting);
      document.getElementById("clear-results-btn").addEventListener("click", clearResults);
      subscribeToVotes();
    } else {
      alert("Incorrect password.");
      document.getElementById("password").value = "";
    }
  });
});
</script>

<style>
@import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
body {
  background-color: black;
  color: white;
  font-family: "Inter", sans-serif;
  overflow: hidden;
}
#login-bg-video {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  object-fit: cover;
  z-index: -1;
  opacity: 0.8;
}
.fullscreen-center {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  width: 100%;
}
.glass-card {
  background-color: rgba(0,0,0,0.45);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 1rem;
  box-shadow: 0 6px 16px rgba(0,0,0,0.4);
  width: 90%;
  max-width: 720px;
  padding: 2rem;
  text-align: center;
}
#results-list {
  display: grid;
  grid-template-rows: repeat(6, 1fr);
  gap: 0.75rem;
  margin-top: 1rem;
}
.frosted-btn {
  backdrop-filter: blur(8px);
  background-color: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.5);
  color: white;
  font-weight: 600;
  padding: 0.55rem 0;
  width: 100%;
  border-radius: 0.5rem;
  transition: all 0.2s ease;
}
.frosted-btn:hover {
  background-color: rgba(255,255,255,0.15);
}
</style>
</head>

<body>
<video autoplay loop muted playsinline id="login-bg-video" src="https://i.imgur.com/Aqrg8yc.mp4"></video>

<!-- Password Screen -->
<section id="login-section" class="fullscreen-center">
  <div class="glass-card flex flex-col items-center justify-center space-y-6">
    <img class="w-full max-w-[160px] mx-auto" src="https://i.imgur.com/EnuWGLA.png" alt="Header">
    <h2 class="text-xl font-bold">Enter Password</h2>
    <form id="login-form" class="w-full max-w-xs mx-auto space-y-3">
      <input id="password" type="password" placeholder="Password"
        class="w-full px-4 py-2 rounded-lg bg-black/40 border border-white/30 text-white text-center focus:outline-none">
      <button type="submit" class="frosted-btn">Enter</button>
    </form>
  </div>
</section>

<!-- Results Screen -->
<section id="results-section" class="fullscreen-center hidden">
  <div class="glass-card">
    <img class="w-full max-w-[160px] mx-auto mb-3" src="https://i.imgur.com/EnuWGLA.png" alt="Header">
    <h3 class="font-bold text-white text-xl mb-2">Live Voting Results</h3>
    <div id="voting-status-label" class="text-green-400 font-semibold mb-2">Voting: ON</div>
    <p id="total-votes" class="text-sm text-white/70 mb-3">Total Votes: 0</p>

    <div class="flex justify-center gap-3 mb-3">
      <button id="toggle-voting-btn" class="px-3 py-2 border border-white/40 rounded-lg text-white text-sm bg-black/30 hover:bg-white/10 transition">Turn Off Voting</button>
      <button id="clear-results-btn" class="px-3 py-2 border border-white/40 rounded-lg text-white text-sm bg-black/30 hover:bg-white/10 transition">Clear Results</button>
    </div>

    <div id="results-list" class="text-white"></div>
    <p class="text-xs text-white/70 mt-2">Refreshing in real-time as votes are cast.</p>
  </div>
</section>
</body>
</html>
