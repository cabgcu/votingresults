<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lip Sync 2025 Results (Admin)</title>

<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {
  getFirestore, collection, query, onSnapshot, doc, setDoc, deleteDoc,
  getDocs, writeBatch
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { initializeAppCheck, ReCaptchaV3Provider }
  from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";

/* ========= Firebase Config ========= */
const firebaseConfig = {
  apiKey: "AIzaSyBoYf1_IhILJ96Y9KMcwrVjHMFLT5YEKuQ",
  authDomain: "lip-sync-2025.firebaseapp.com",
  projectId: "lip-sync-2025",
  storageBucket: "lip-sync-2025.appspot.com",
  messagingSenderId: "118581305479",
  appId: "1:118581305479:web:7a7335c1be6e816cc7d822",
  measurementId: "G-NQ0GMG05Q2"
};

/* ========= Firebase Init ========= */
const app = initializeApp(firebaseConfig);
initializeAppCheck(app, {
  provider: new ReCaptchaV3Provider('6LdIDf8rAAAAAN29EDUYVkddlpw3QQy9ImSPFpm1'),
  isTokenAutoRefreshEnabled: true
});

const db = getFirestore(app);
const auth = getAuth(app);
const allowedAdmins = [
  "Mkcsfn5E4LSOiiXeCl7sVgCrCzr2",
  "HYkN0qZc8aNgGOtrxT0VWKBWYbO2",
  "YOUR_NEW_UID_HERE"
];
let votingEnabled = true;

/* ========= Firestore listener ========= */
function subscribeToVotes() {
  const q = query(collection(db, "lip_sync_2025_votes"));
  onSnapshot(q, (snap) => {
    const groups = {
      arena: { option1:0, option2:0, option3:0, option4:0, option5:0, option6:0 },
      online: { option1:0, option2:0, option3:0, option4:0, option5:0, option6:0 }
    };
    snap.forEach(d => {
      const data = d.data();
      const source = data.voteSource === "online" ? "online" : "arena";
      if (data.voteId && groups[source].hasOwnProperty(data.voteId)) {
        groups[source][data.voteId]++;
      }
    });
    const combined = {};
    Object.keys(groups.arena).forEach(k => {
      combined[k] = (groups.arena[k] || 0) + (groups.online[k] || 0);
    });
    renderAll(groups, combined);
  });

  onSnapshot(doc(db, "lip_sync_2025_settings", "state"), (snap) => {
    if (snap.exists()) {
      votingEnabled = snap.data().enabled;
      updateStatus();
    }
  });
}

/* ========= Render All ========= */
function renderAll(groups, combined) {
  const names = ["Below","Deliverance","Mask Off","Metro Motion","Sin Game","Anonymity"];
  renderGroup("combined", combined, names);
  renderGroup("arena", groups.arena, names);
  renderGroup("online", groups.online, names);
  const arenaTotal = Object.values(groups.arena).reduce((a,b)=>a+b,0);
  const onlineTotal = Object.values(groups.online).reduce((a,b)=>a+b,0);
  const combinedTotal = Object.values(combined).reduce((a,b)=>a+b,0);
  document.getElementById("arena-total").textContent = `Arena Votes: ${arenaTotal}`;
  document.getElementById("online-total").textContent = `Online Votes: ${onlineTotal}`;
  document.getElementById("combined-total").textContent = `Total Combined Votes: ${combinedTotal}`;
}

function renderGroup(groupName, counts, names) {
  const total = Object.values(counts).reduce((a,b)=>a+b,0);
  const container = document.getElementById(`${groupName}-results`);
  if (!container) return;
  container.innerHTML = Object.keys(counts).map((id,i)=>{
    const pct = total ? ((counts[id]/total)*100).toFixed(1) : 0;
    return `
      <div class="space-y-1 text-white">
        <div class="flex justify-between text-xs sm:text-sm">
          <span>${names[i]}</span>
          <span>${counts[id]} votes (${pct}%)</span>
        </div>
        <div class="w-full h-3 bg-white/10 rounded-full overflow-hidden">
          <div class="h-full bg-green-500 transition-all duration-700 ease-in-out" style="width:${pct}%"></div>
        </div>
      </div>`;
  }).join('');
}

/* ========= Toggle Voting ========= */
async function toggleVoting() {
  votingEnabled = !votingEnabled;
  await setDoc(doc(db, "lip_sync_2025_settings", "state"), { enabled: votingEnabled });
  updateStatus();
}

/* ========= ⚡ Optimized Clear Function ========= */
async function clearResults() {
  if (!confirm("⚠️ This will reset ALL votes, fingerprints, and student ID locks. Continue?")) return;

  const clearBtn = document.getElementById("clear-results-btn");
  const progress = document.getElementById("progress-bar");
  clearBtn.disabled = true;
  clearBtn.textContent = "Clearing…";

  const updateStatus = (msg) => {
    document.getElementById("combined-total").textContent = msg;
  };

  async function batchProcess(colName, isReset=false) {
    const snap = await getDocs(collection(db, colName));
    const docs = snap.docs;
    let processed = 0, total = docs.length, written = 0;

    for (let i = 0; i < docs.length; i += 400) {
      const slice = docs.slice(i, i + 400);
      const batch = writeBatch(db);
      slice.forEach(d => {
        if (isReset) {
          const data = d.data();
          if (data.hasVoted) { // only reset if true
            batch.set(d.ref, { hasVoted: false }, { merge: true });
            written++;
          }
        } else {
          batch.delete(d.ref);
          written++;
        }
      });
      await batch.commit();
      processed += slice.length;
      const pct = Math.min(100, Math.round((processed / total) * 100));
      progress.style.width = pct + "%";
      updateStatus(`Clearing ${colName}: ${processed}/${total} (${written} writes)`);
    }
  }

  try {
    await batchProcess("lip_sync_2025_votes");
    await batchProcess("voted_fingerprints");
    await batchProcess("student_ids", true);
    updateStatus("✅ All data cleared and student IDs reset!");
    alert("✅ Clear complete!");
  } catch (err) {
    console.error(err);
    alert("❌ Failed to clear data: " + (err.message || err));
  } finally {
    clearBtn.disabled = false;
    clearBtn.textContent = "Clear Results";
    progress.style.width = "0%";
  }
}

/* ========= UI helpers ========= */
function updateStatus() {
  const label = document.getElementById("voting-status-label");
  label.textContent = votingEnabled ? "Voting: ON" : "Voting: OFF";
  label.className = votingEnabled ? "text-green-400 font-semibold mb-2" : "text-red-400 font-semibold mb-2";
  document.getElementById("toggle-voting-btn").textContent = votingEnabled ? "Turn Off Voting" : "Turn On Voting";
}

/* ========= Auth ========= */
async function handleSignIn(email, password) {
  try {
    const userCred = await signInWithEmailAndPassword(auth, email, password);
    const uid = userCred.user.uid;
    if (!allowedAdmins.includes(uid)) {
      alert("Access denied: you are not authorized.");
      await signOut(auth);
      return;
    }
    document.getElementById("login-section").classList.add("hidden");
    document.getElementById("results-section").classList.remove("hidden");
    document.getElementById("admin-status").textContent = `Signed in as ${email} (Admin)`;
    subscribeToVotes();
    updateStatus();
  } catch (e) {
    alert("Sign-in failed: " + (e.message || e));
  }
}

async function handleSignOut() {
  await signOut(auth);
  document.getElementById("results-section").classList.add("hidden");
  document.getElementById("login-section").classList.remove("hidden");
  document.getElementById("email").value = "";
  document.getElementById("password").value = "";
}

onAuthStateChanged(auth, (user) => {
  if (!user) {
    document.getElementById("login-section").classList.remove("hidden");
    document.getElementById("results-section").classList.add("hidden");
  }
});

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("login-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value.trim();
    await handleSignIn(email, password);
  });
  document.getElementById("toggle-voting-btn").addEventListener("click", toggleVoting);
  document.getElementById("clear-results-btn").addEventListener("click", clearResults);
  document.getElementById("signout-btn").addEventListener("click", handleSignOut);
});
</script>

<style>
@import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap");
body {
  background-color: black;
  color: white;
  font-family: "Inter", sans-serif;
  overflow: hidden;
}
#login-bg-video {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  object-fit: cover;
  z-index: -1;
  opacity: 0.8;
}
.fullscreen-center {
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  width: 100%;
}
.glass-card {
  background-color: rgba(0,0,0,0.45);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: 1rem;
  box-shadow: 0 6px 16px rgba(0,0,0,0.4);
  width: 90%;
  max-width: 720px;
  padding: 2rem;
  text-align: center;
}
.frosted-btn {
  backdrop-filter: blur(8px);
  background-color: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.5);
  color: white;
  font-weight: 600;
  padding: 0.55rem 0.75rem;
  border-radius: 0.5rem;
  transition: all 0.2s ease;
}
.frosted-btn:hover { background-color: rgba(255,255,255,0.12); }
.small { font-size: 0.9rem; padding: 0.4rem 0.6rem; }
.section-title {
  font-weight: 700;
  font-size: 1.1rem;
  margin-top: 1.2rem;
  margin-bottom: 0.4rem;
  text-align: left;
}
#progress-container {
  width: 100%;
  height: 6px;
  background: rgba(255,255,255,0.1);
  border-radius: 6px;
  overflow: hidden;
  margin-top: 8px;
}
#progress-bar {
  height: 100%;
  width: 0%;
  background: linear-gradient(to right, #22c55e, #16a34a);
  transition: width 0.3s ease;
}
</style>
</head>

<body>
<video autoplay loop muted playsinline id="login-bg-video" src="https://i.imgur.com/mAzP2S1.mp4"></video>

<!-- Admin Login -->
<section id="login-section" class="fullscreen-center">
  <div class="glass-card flex flex-col items-center justify-center space-y-6">
    <img class="w-full max-w-[160px]" src="https://i.imgur.com/EnuWGLA.png" alt="Header">
    <h2 class="text-xl font-bold">Admin Login</h2>
    <form id="login-form" class="w-full max-w-xs mx-auto space-y-3">
      <input id="email" type="email" placeholder="Admin Email"
        class="w-full px-4 py-2 rounded-lg bg-black/40 border border-white/30 text-white text-center focus:outline-none">
      <input id="password" type="password" placeholder="Password"
        class="w-full px-4 py-2 rounded-lg bg-black/40 border border-white/30 text-white text-center focus:outline-none">
      <button type="submit" class="frosted-btn small w-full">Sign In</button>
    </form>
    <p class="text-sm text-white/60">Only authorized administrators may access this dashboard.</p>
  </div>
</section>

<!-- Results Screen -->
<section id="results-section" class="fullscreen-center hidden">
  <div class="glass-card relative overflow-y-auto max-h-[95vh]">
    <button id="signout-btn" class="absolute top-4 right-4 frosted-btn small">Sign Out</button>
    <img class="w-full max-w-[160px] mx-auto mb-3" src="https://i.imgur.com/EnuWGLA.png" alt="Header">
    <h3 class="font-bold text-white text-xl mb-2">Live Voting Results</h3>

    <div class="flex items-center justify-between mb-3">
      <div>
        <div id="voting-status-label" class="text-green-400 font-semibold mb-1">Voting: ON</div>
        <div id="combined-total" class="text-sm text-white/70">Total Combined Votes: 0</div>
        <div id="arena-total" class="text-sm text-white/70">Arena Votes: 0</div>
        <div id="online-total" class="text-sm text-white/70">Online Votes: 0</div>
        <div id="progress-container"><div id="progress-bar"></div></div>
      </div>
      <div class="flex gap-2 items-center">
        <button id="toggle-voting-btn" class="frosted-btn small">Turn Off Voting</button>
        <button id="clear-results-btn" class="frosted-btn small">Clear Results</button>
      </div>
    </div>

    <h4 class="section-title">Total Combined Votes</h4>
    <div id="combined-results" class="space-y-2 mb-4"></div>

    <h4 class="section-title">Arena Votes</h4>
    <div id="arena-results" class="space-y-2 mb-4"></div>

    <h4 class="section-title">Online Votes</h4>
    <div id="online-results" class="space-y-2 mb-4"></div>

    <div class="mt-4 flex items-center justify-between">
      <div id="admin-status" class="text-sm text-white/60">Not signed in</div>
    </div>
    <p class="text-xs text-white/70 mt-2">Refreshing in real time as votes are cast.</p>
  </div>
</section>
</body>
</html>
